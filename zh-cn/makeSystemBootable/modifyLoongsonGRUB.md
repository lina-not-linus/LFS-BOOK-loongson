使用loongson发布的GRUB并设置引导
=============================

# 概述

由于龙芯主板厂商众多，根据不同需求制作的主板在BIOS引导方面也不一致，不过大体上分为两种：PMON和Kunlun。且这两种BIOS固件的机器皆不能引导官方版的Grub，所以在这儿不能直接使用官方LFS教程的做法来安装配置龙芯机器的Grub，且这两种BIOS固件使得Grub在引导过程中读取的是不同的配置文件，这导致在BIOS在完成自己的工作之后Grub对系统的引导上出现不同的情况，其内在原因不在此处阐述，本章节内容主要说明如何配置Grub。
_____________________________


## 当BIOS为昆仑固件的情况下GRUB的配置

### 创建GRUB配置文件

 生成/boot/grub.cfg文件
```sh
cat > /boot/grub/grub.cfg << "EOF"
#
# DO NOT EDIT THIS FILE
#
# It is automatically generated by grub2-mkconfig using templates
# from /etc/grub.d and settings from /etc/default/grub
#

### BEGIN /etc/grub.d/00_header ###
insmod search
insmod search_fs_uuid
insmod search_fs_file
insmod search_label
insmod loadenv
insmod font
set pager=1

if [ -s $prefix/grubenv ]; then
  load_env
fi
if [ "${next_entry}" ] ; then
   set default="${next_entry}"
   set next_entry=
   save_env next_entry
   set boot_once=true
else
   set default="${saved_entry}"
fi

if [ x"${feature_menuentry_id}" = xy ]; then
  menuentry_id_option="--id"
else
  menuentry_id_option=""
fi

export menuentry_id_option

if [ "${prev_saved_entry}" ]; then
  set saved_entry="${prev_saved_entry}"
  save_env saved_entry
  set prev_saved_entry=
  save_env prev_saved_entry
  set boot_once=true
fi

function savedefault {
  if [ -z "${boot_once}" ]; then
    saved_entry="${chosen}"
    save_env saved_entry
  fi
}

function load_video {
  if [ x$feature_all_video_module = xy ]; then
    insmod all_video
  else
    insmod efi_gop
    insmod efi_uga
    insmod ieee1275_fb
    insmod vbe
    insmod vga
    insmod video_bochs
    insmod video_cirrus
  fi
}

if [ x$feature_default_font_path = xy ] ; then
   font=unicode
else
insmod part_msdos
insmod ext2
set root='hd0,msdos2'
if [ x$feature_platform_search_hint = xy ]; then
  search --no-floppy --fs-uuid --set=root --hint-bios=hd0,msdos2 --hint-efi=hd0,msdos2 --hint-baremetal=ahci0,msdos2  1562f975-b97d-4477-9909-879f0d60a061
else
  search --no-floppy --fs-uuid --set=root 1562f975-b97d-4477-9909-879f0d60a061
fi
    font="/usr/share/grub/unicode.pf2"
fi

if loadfont $font ; then
  set gfxmode=auto
  load_video
  insmod gfxterm
  set locale_dir=$prefix/locale
  set lang=zh_CN
  insmod gettext
fi
terminal_output gfxterm
if [ x$feature_timeout_style = xy ] ; then
  set timeout_style=menu
  set timeout=5
# Fallback normal timeout code in case the timeout_style feature is
# unavailable.
else
  set timeout=5
fi
### END /etc/grub.d/00_header ###

### BEGIN /etc/grub.d/10_linux ###
menuentry 'Fedora GNU/Linux，Linux 4.9.88' --class fedora --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option 'gnulinux-4.9.80-1.fc21.lemote.1.mips64el-advanced-1562f975-b97d-4477-9909-879f0d60a061' {
        load_video
        insmod gzio
        insmod part_msdos
        insmod ext2
        set root='hd0,msdos1'
        if [ x$feature_platform_search_hint = xy ]; then
          search --no-floppy --fs-uuid --set=root --hint-bios=hd0,msdos1 --hint-efi=hd0,msdos1 --hint-baremetal=ahci0,msdos1  7a210ac1-e919-4d31-b1f9-6944b2268fb4
        else
          search --no-floppy --fs-uuid --set=root 7a210ac1-e919-4d31-b1f9-6944b2268fb4
        fi
        echo    '载入 Linux 4.9.88 ...'
        linux   /boot/vmlinuz-4.9.88 root=/dev/[sdaX] ro rhgb 
        boot
}

### END /etc/grub.d/10_linux ###

### BEGIN /etc/grub.d/20_linux_xen ###
### END /etc/grub.d/20_linux_xen ###

### BEGIN /etc/grub.d/30_os-prober ###
### END /etc/grub.d/30_os-prober ###

### BEGIN /etc/grub.d/40_custom ###
# This file provides an easy way to add custom menu entries.  Simply type the
# menu entries you want to add after this comment.  Be careful not to change
# the 'exec tail' line above.
### END /etc/grub.d/40_custom ###

### BEGIN /etc/grub.d/41_custom ###
if [ -f  ${config_directory}/custom.cfg ]; then
  source ${config_directory}/custom.cfg
elif [ -z "${config_directory}" -a -f  $prefix/custom.cfg ]; then
  source $prefix/custom.cfg;
fi
### END /etc/grub.d/41_custom ###

EOF


```
生成文件后需要注意几个需要根据实际情况进行修改的参数，比如`set root='hd0,msdos1'`是指定根目录所在分区的条目，其中中的`'hd0,msdos1'`是指明该硬盘分区是MBR分区表第一个分区，如果你在分区时使用GPT分区表，这一部分需要修改成`'hd0,gptN'`,`N`代表根目录所在分区的标号。还有`linux   /boot/vmlinuz-4.9.88 root=/dev/[sdaX] ...`中的`[sdaX]`为根目录所在硬盘分区。一般修改这几项就能在配置完成并且重启后正常使用了。


_____________________________

# BIOS为PMON的情况下GRUB的配置

生成/boot/boot.cfg文件
```sh
cat > /boot/grub/grub.cfg << "EOF"
# Begin /boot/grub/grub.cfg
set default=0
set timeout=5
showmenu 1

insmod ext2
set root=(hd0,2)

menuentry "GNU/Linux, Linux 4.15.3-lfs-8.2-systemd" {
        kernel  (wd0,0)/boot/vmlinuz-4.88 root=/dev/sda2 
	args root=/sda/[sdaX] rhgb
}
EOF

```
同样的，`X`表示根目录所在的硬盘分区
_____________________________

##### 注意
> 从GRUB的角度来看，无论使用哪种BIOS，内核文件与使用的分区相关。 如果您使用单独的/boot分区，请从上面的linux行中删除"/boot"。 您还需要将设置的根行更改为指向引导分区。



GRUB是一个功能非常强大的程序，它提供了从各种设备，操作系统和分区类型启动的大量选项。 还有许多自定义选项，例如图形启动画面，播放声音，鼠标输入等。这些选项的细节超出了本介绍的范围可在之后自行尝试。
